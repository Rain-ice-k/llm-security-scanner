name: DeepSeek Code Security Scan

# è§¦å‘æ¡ä»¶ï¼šå½“æŽ¨é€åˆ° main åˆ†æ”¯ï¼Œæˆ–è€…æœ‰ Pull Request æ—¶è§¦å‘
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  # å…è®¸åœ¨ GitHub ç½‘é¡µä¸Šæ‰‹åŠ¨ç‚¹å‡»è¿è¡Œ
  workflow_dispatch:

jobs:
  security-scan:
    runs-on: ubuntu-latest

    # æƒé™è®¾ç½®ï¼šå…è®¸è¯»å–ä»£ç ï¼Œå…è®¸ä¸Šä¼  Security Events (å¦‚æžœæœ‰)
    permissions:
      contents: read
      security-events: write

    steps:
      # 1. æ‹‰å–ä»“åº“ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. è®¾ç½® Python çŽ¯å¢ƒ
      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # 3. å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # 4. è¿è¡Œä½ çš„æ‰«æå™¨ (å…³é”®æ­¥éª¤)
      - name: Run DeepSeek Scanner
        env:
          # ä»Ž GitHub Secrets ä¸­èŽ·å– API Keyï¼Œä¸è¦å†™æ­»ï¼
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          # ç¡®ä¿ scripts ç›®å½•åœ¨ PYTHONPATH ä¸­ï¼Œæˆ–è€…ç›´æŽ¥è¿è¡Œè„šæœ¬
          # æˆ‘ä»¬è¿™é‡Œæ‰«æ vulnerable_code ç›®å½•
          python scripts/llm_security_scanner.py --target ./vulnerable_code --recursive --output report.md

      # 5. ä¸Šä¼ æ‰«ææŠ¥å‘Šä½œä¸º Artifact (æž„ä»¶)
      # è¿™æ ·ä½ å¯ä»¥åœ¨ GitHub é¡µé¢ä¸Šä¸‹è½½æŸ¥çœ‹ç”Ÿæˆçš„ report.md
      - name: Upload Scan Report
        uses: actions/upload-artifact@v3
        with:
          name: security-report
          path: report.md

      # 6. (è¿›é˜¶) ç›´æŽ¥åœ¨ Job æ‘˜è¦ä¸­æ˜¾ç¤ºæŠ¥å‘Šå†…å®¹
      - name: Publish Report to Job Summary
        if: always() # å³ä½¿ä¸Šé¢æŠ¥é”™ä¹Ÿè¿è¡Œ
        run: |
          echo "## ðŸ›¡ï¸ DeepSeek Security Report" >> $GITHUB_STEP_SUMMARY
          cat report.md >> $GITHUB_STEP_SUMMARY